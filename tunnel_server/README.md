# Tunnel Server

–°–µ—Ä–≤–µ—Ä –¥–ª—è —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º –∞–≥–µ–Ω—Ç–æ–≤.

> üìñ –°–º. —Ç–∞–∫–∂–µ [–æ–±—â–∏–π README](../README.md) –¥–ª—è –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:

- **presentation** - CLI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **application** - Use cases (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- **domain** - –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
- **infrastructure** - –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å–µ—Ç—å, –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **interfaces** - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (–∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)
- **common** - –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (–æ—à–∏–±–∫–∏, –ø—Ä–æ—Ç–æ–∫–æ–ª)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
cd tunnel_server
pip install -e .
```

## –ó–∞–ø—É—Å–∫

### –°–ø–æ—Å–æ–± 1: –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
cd tunnel_server
pip install -e .
tunnel-server --bind 0.0.0.0 --control 7000 --port-min 10000 --port-max 11000 --token mysecret
```

### –°–ø–æ—Å–æ–± 2: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

```bash
cd tunnel_server
python run_server.py --bind 0.0.0.0 --control 7000 --port-min 10000 --port-max 11000 --token mysecret
```

### –°–ø–æ—Å–æ–± 3: –ó–∞–ø—É—Å–∫ –∫–∞–∫ –º–æ–¥—É–ª—å

```bash
cd tunnel_server
python -m server_app.main --bind 0.0.0.0 --control 7000 --port-min 10000 --port-max 11000 --token mysecret
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `--bind` - –ê–¥—Ä–µ—Å –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.0.0.0)
- `--control` - –ü–æ—Ä—Ç –¥–ª—è control –∫–∞–Ω–∞–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 7000)
- `--port-min` - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10000)
- `--port-max` - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 11000)
- `--token` - –¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
tunnel-server --token mysecret --port-min 10000 --port-max 10010
```

2. –°–µ—Ä–≤–µ—Ä –≤—ã–≤–µ–¥–µ—Ç:
```
Control server listening on 0.0.0.0:7000
Port range: [10000, 10010]
```

3. –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞ —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–µ–ª–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç –∏ –≤—ã–≤–µ–¥–µ—Ç:
```
Agent registered: <agent_id>, local=localhost:8080, public_port=10000
```

## –ü—Ä–æ—Ç–æ–∫–æ–ª

–°–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Ñ—Ä–µ–π–º–æ–≤:

- **Header**: `type (uint8) + conn_id (uint32) + length (uint32 BE)`
- **Payload**: –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

- `HELLO (1)` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
- `WELCOME (2)` - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –ø—É–±–ª–∏—á–Ω—ã–º –ø–æ—Ä—Ç–æ–º
- `OPEN (3)` - –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- `DATA (4)` - –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö
- `CLOSE (5)` - –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
pytest tests/
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
tunnel_server/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ server_app/
‚îÇ       ‚îú‚îÄ‚îÄ main.py
‚îÇ       ‚îú‚îÄ‚îÄ presentation/
‚îÇ       ‚îú‚îÄ‚îÄ application/
‚îÇ       ‚îú‚îÄ‚îÄ domain/
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îú‚îÄ‚îÄ interfaces/
‚îÇ       ‚îî‚îÄ‚îÄ common/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ pyproject.toml
```

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–û–±—â–∏–π README –ø—Ä–æ–µ–∫—Ç–∞](../README.md)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Tunnel Client](../tunnel_client/README.md)

