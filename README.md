# PortForwarder

Система туннелирования портов для проксирования внешних соединений к локальным сервисам через централизованный сервер.

## Описание

PortForwarder состоит из двух компонентов:

- **Tunnel Server** - сервер, который принимает подключения от клиентов (агентов) и проксирует внешние соединения к их локальным сервисам
- **Tunnel Client** - клиент с графическим интерфейсом для подключения к серверу и настройки туннелей

### Как это работает

1. Клиент подключается к серверу через control канал и регистрируется с указанием локального сервиса (host:port)
2. Сервер выделяет публичный порт для клиента
3. Внешние клиенты подключаются к серверу на выделенном публичном порту
4. Сервер проксирует трафик между внешними клиентами и локальным сервисом клиента через туннель

```
[Внешний клиент] → [Tunnel Server:Public Port] → [Control Channel] → [Tunnel Client] → [Локальный сервис]
```

## Требования

- **Python 3.11+**
- Для клиента: Tkinter (обычно идет в комплекте с Python)

## Быстрый старт

### 1. Установка сервера

```bash
cd tunnel_server
pip install -e .
```

### 2. Установка клиента

```bash
cd tunnel_client
pip install -e .
```

### 3. Запуск сервера

```bash
cd tunnel_server
tunnel-server --token mysecret --port-min 10000 --port-max 11000
```

### 4. Запуск клиента

```bash
cd tunnel_client
tunnel-client
```

Или на Windows можно просто дважды кликнуть по `run_client.py`.

## Структура проекта

```
PortForwarder/
├── tunnel_server/          # Серверная часть
│   ├── src/
│   │   └── server_app/     # Приложение сервера
│   ├── tests/              # Тесты сервера
│   └── README.md           # Документация сервера
│
├── tunnel_client/          # Клиентская часть
│   ├── src/
│   │   └── client_app/     # Приложение клиента
│   ├── tests/              # Тесты клиента
│   └── README.md           # Документация клиента
│
└── README.md               # Этот файл
```

## Архитектура

Оба компонента следуют принципам **SOLID** и используют **слоистую архитектуру** (Clean Architecture):

- **presentation** - Интерфейс пользователя (CLI для сервера, GUI для клиента)
- **application** - Use cases (бизнес-логика)
- **domain** - Доменные сущности
- **infrastructure** - Реализации (сеть, персистентность, логирование)
- **interfaces** - Интерфейсы (абстракции)
- **common** - Общие утилиты (ошибки, протокол)

## Протокол

Система использует бинарный протокол фреймов:

- **Header**: `type (uint8) + conn_id (uint32) + length (uint32 BE)`
- **Payload**: данные сообщения

### Типы сообщений

- `HELLO (1)` - Регистрация агента
- `WELCOME (2)` - Подтверждение регистрации с публичным портом
- `OPEN (3)` - Открытие нового соединения
- `DATA (4)` - Передача данных
- `CLOSE (5)` - Закрытие соединения

## Пример использования

### Сценарий: Проброс локального веб-сервера

1. **Запустите локальный веб-сервер** на порту 8080:
   ```bash
   python -m http.server 8080
   ```

2. **Запустите Tunnel Server**:
   ```bash
   tunnel-server --token mysecret --port-min 10000 --port-max 10010
   ```

3. **Запустите Tunnel Client** и настройте подключение:
   - Server Host: `localhost` (или IP сервера)
   - Server Port: `7000`
   - Token: `mysecret` (Здесь вводится токен, введённый при запуске сервера)
   - Local Port: `8080`

4. **После подключения** клиент получит публичный порт (например, 10000)

5. **Внешние клиенты** могут теперь подключаться к `server_ip:10000`, и их трафик будет проксироваться к вашему локальному серверу на `localhost:8080`

## Тестирование

### Тесты сервера

```bash
cd tunnel_server
pytest tests/
```

### Тесты клиента

```bash
cd tunnel_client
pytest tests/
```

## Документация

- [Документация Tunnel Server](tunnel_server/README.md)
- [Документация Tunnel Client](tunnel_client/README.md)

## Особенности

- ✅ **Асинхронная архитектура** - Использует asyncio для высокой производительности
- ✅ **Неблокирующий UI** - GUI клиента работает без блокировок
- ✅ **Безопасность** - Аутентификация через токен
- ✅ **Множественные соединения** - Поддержка нескольких одновременных соединений
- ✅ **Автоматическое управление портами** - Сервер автоматически выделяет свободные порты
- ✅ **Корректное закрытие** - Все соединения закрываются корректно при отключении

## Лицензия

Проект находится в разработке.

